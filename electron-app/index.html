<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dr. Dangs Fingerprint Service</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #3b82f6;
      --success: #10b981;
      --success-dark: #059669;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
      min-height: 100vh;
      color: var(--gray-800);
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-right: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-text h1 {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .logo-text p {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    .version-badge {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      font-size: 0.7rem;
      margin-top: 8px;
    }

    .nav-menu {
      flex: 1;
      padding: 16px 0;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 24px;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: var(--gray-50);
      color: var(--primary);
    }

    .nav-item.active {
      background: #eff6ff;
      color: var(--primary);
      border-left-color: var(--primary);
      font-weight: 600;
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
    }

    .status-panel {
      padding: 16px 24px;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
    }

    .status-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.8rem;
    }

    .status-label {
      color: var(--gray-500);
    }

    .status-value {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.online { background: var(--success); }
    .status-dot.offline { background: var(--danger); }
    .status-dot.warning { background: var(--warning); }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: white;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: rgba(255,255,255,0.7);
      font-size: 0.95rem;
    }

    /* Cards */
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-800);
    }

    .card-body {
      padding: 24px;
    }

    /* Fingerprint Scanner Section */
    .scanner-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .fingerprint-capture-area {
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      border: 3px dashed var(--gray-300);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      transition: all 0.3s ease;
      min-height: 350px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .fingerprint-capture-area.active {
      border-color: var(--primary);
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }

    .fingerprint-capture-area.success {
      border-color: var(--success);
      background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
    }

    .fingerprint-capture-area.error {
      border-color: var(--danger);
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    }

    .fingerprint-icon {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
    }

    .fingerprint-icon svg {
      width: 100%;
      height: 100%;
      color: var(--gray-400);
      transition: all 0.3s;
    }

    .fingerprint-capture-area.active .fingerprint-icon svg {
      color: var(--primary);
      animation: pulse-scan 1.5s infinite;
    }

    .fingerprint-capture-area.success .fingerprint-icon svg {
      color: var(--success);
    }

    @keyframes pulse-scan {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .fingerprint-image-container {
      width: 180px;
      height: 210px;
      margin: 0 auto 20px;
      background: var(--gray-200);
      border-radius: 12px;
      overflow: hidden;
      display: none;
      border: 3px solid var(--success);
    }

    .fingerprint-capture-area.success .fingerprint-image-container {
      display: block;
    }

    .fingerprint-capture-area.success .fingerprint-icon {
      display: none;
    }

    .fingerprint-image-container canvas {
      width: 100%;
      height: 100%;
    }

    .capture-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .capture-subtext {
      font-size: 0.9rem;
      color: var(--gray-500);
    }

    /* Quality Meter */
    .quality-meter {
      margin-top: 24px;
      width: 100%;
      max-width: 280px;
    }

    .quality-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .quality-label {
      color: var(--gray-600);
      font-weight: 500;
    }

    .quality-value {
      font-weight: 700;
    }

    .quality-value.excellent { color: var(--success); }
    .quality-value.good { color: var(--primary); }
    .quality-value.fair { color: var(--warning); }
    .quality-value.poor { color: var(--danger); }

    .quality-bar {
      height: 10px;
      background: var(--gray-200);
      border-radius: 5px;
      overflow: hidden;
    }

    .quality-fill {
      height: 100%;
      border-radius: 5px;
      transition: all 0.5s ease;
    }

    .quality-fill.excellent { background: linear-gradient(90deg, var(--success) 0%, #34d399 100%); }
    .quality-fill.good { background: linear-gradient(90deg, var(--primary) 0%, #60a5fa 100%); }
    .quality-fill.fair { background: linear-gradient(90deg, var(--warning) 0%, #fbbf24 100%); }
    .quality-fill.poor { background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%); }

    .quality-thresholds {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.7rem;
      color: var(--gray-400);
    }

    /* Patient Info Panel */
    .patient-info-panel {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 0.95rem;
      background: white;
      cursor: pointer;
    }

    /* Finger Selection */
    .finger-selector {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 16px;
    }

    .finger-btn {
      padding: 10px 4px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 0.7rem;
      color: var(--gray-600);
      transition: all 0.2s;
    }

    .finger-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .finger-btn.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }

    .finger-btn.enrolled {
      border-color: var(--success);
      background: #ecfdf5;
      color: var(--success);
    }

    .finger-btn.selected {
      border-color: var(--primary);
      background: #eff6ff;
      color: var(--primary);
    }

    .finger-btn.capturing {
      border-color: var(--warning);
      background: #fffbeb;
      color: #92400e;
      animation: pulse-border 1s infinite;
    }

    @keyframes pulse-border {
      0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2); }
    }

    .enrolled-finger-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: #ecfdf5;
      border: 1px solid var(--success);
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--success);
    }

    .enrolled-finger-badge svg {
      width: 12px;
      height: 12px;
    }

    .finger-icon {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }

    /* Action Buttons */
    .action-buttons {
      display: grid;
      gap: 12px;
      margin-top: 24px;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
    }

    .btn-secondary {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--gray-200);
    }

    .btn-outline {
      background: white;
      border: 2px solid var(--gray-300);
      color: var(--gray-700);
    }

    .btn-outline:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
    }

    .btn-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Results Panel */
    .results-panel {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-200);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-label {
      color: var(--gray-600);
      font-size: 0.9rem;
    }

    .result-value {
      font-weight: 600;
      color: var(--gray-800);
    }

    .result-value.match {
      color: var(--success);
    }

    .result-value.no-match {
      color: var(--danger);
    }

    /* Accuracy Badge */
    .accuracy-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #92400e;
      margin-top: 16px;
    }

    .accuracy-badge svg {
      width: 16px;
      height: 16px;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
      max-width: 380px;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.warning { border-left: 4px solid var(--warning); }
    .toast.info { border-left: 4px solid var(--primary); }

    .toast-icon {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--gray-800);
    }

    .toast-message {
      font-size: 0.85rem;
      color: var(--gray-600);
      margin-top: 2px;
    }

    /* Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .spinner-dark {
      border-color: rgba(0,0,0,0.1);
      border-top-color: var(--primary);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Settings Page */
    .settings-grid {
      display: grid;
      gap: 24px;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--gray-100);
    }

    .setting-info h4 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--gray-800);
    }

    .setting-info p {
      font-size: 0.85rem;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .setting-control {
      min-width: 200px;
    }

    /* Industrial Grade Indicator */
    .industrial-grade {
      background: linear-gradient(135deg, #065f46 0%, #047857 100%);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .industrial-grade-icon {
      width: 40px;
      height: 40px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .industrial-grade-text h4 {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .industrial-grade-text p {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* Page Views */
    .page-view {
      display: none;
    }

    .page-view.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .scanner-section {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 80px;
      }

      .sidebar-header {
        padding: 16px;
      }

      .logo-text, .nav-item span, .status-panel {
        display: none;
      }

      .nav-item {
        justify-content: center;
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-container">
          <div class="logo-icon">
            <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor">
              <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21z"/>
            </svg>
          </div>
          <div class="logo-text">
            <h1>Dr. Dangs Lab</h1>
            <p>Fingerprint Service</p>
          </div>
        </div>
        <span class="version-badge">v2.0.0 Industrial</span>
      </div>

      <nav class="nav-menu">
        <div class="nav-item active" onclick="showPage('capture')">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28z"/>
          </svg>
          <span>Capture</span>
        </div>
        <div class="nav-item" onclick="showPage('enroll')">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          <span>Enroll Patient</span>
        </div>
        <div class="nav-item" onclick="showPage('verify')">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
          </svg>
          <span>Verify Patient</span>
        </div>
        <div class="nav-item" onclick="showPage('settings')">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
          </svg>
          <span>Settings</span>
        </div>
      </nav>

      <div class="status-panel">
        <div class="status-item">
          <span class="status-label">Scanner</span>
          <span class="status-value">
            <span class="status-dot" id="scannerDot"></span>
            <span id="scannerStatus">Checking...</span>
          </span>
        </div>
        <div class="status-item">
          <span class="status-label">Server</span>
          <span class="status-value">
            <span class="status-dot" id="serverDot"></span>
            <span id="serverStatus">Checking...</span>
          </span>
        </div>
        <div class="status-item">
          <span class="status-label">Accuracy</span>
          <span class="status-value" style="color: var(--success);">
            <span>FAR &lt; 0.01%</span>
          </span>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Capture Page -->
      <div class="page-view active" id="page-capture">
        <div class="page-header">
          <h2 class="page-title">Fingerprint Capture</h2>
          <p class="page-subtitle">Capture high-quality fingerprints for enrollment or verification</p>
        </div>

        <div class="industrial-grade">
          <div class="industrial-grade-icon">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
          </div>
          <div class="industrial-grade-text">
            <h4>Industrial Grade Biometrics</h4>
            <p>FAR &lt; 0.01% | FRR &lt; 0.1% | ISO/IEC 19795 Compliant</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Fingerprint Scanner</span>
            <button class="btn btn-outline" onclick="toggleConnection()" id="connectBtn">
              <span id="connectBtnText">Connect</span>
            </button>
          </div>
          <div class="card-body">
            <div class="scanner-section">
              <div class="fingerprint-capture-area" id="captureArea">
                <div class="fingerprint-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28zM3.5 9.72c-.1 0-.2-.03-.29-.09-.23-.16-.28-.47-.12-.7.99-1.4 2.25-2.5 3.75-3.27C9.98 4.04 14 4.03 17.15 5.65c1.5.77 2.76 1.86 3.75 3.25.16.22.11.54-.12.7-.23.16-.54.11-.7-.12-.9-1.26-2.04-2.25-3.39-2.94-2.87-1.47-6.54-1.47-9.4.01-1.36.7-2.5 1.7-3.4 2.96-.08.14-.23.21-.39.21zm6.25 12.07c-.13 0-.26-.05-.35-.15-.87-.87-1.34-1.43-2.01-2.64-.69-1.23-1.05-2.73-1.05-4.34 0-2.97 2.54-5.39 5.66-5.39s5.66 2.42 5.66 5.39c0 .28-.22.5-.5.5s-.5-.22-.5-.5c0-2.42-2.09-4.39-4.66-4.39-2.57 0-4.66 1.97-4.66 4.39 0 1.44.32 2.77.93 3.85.64 1.15 1.08 1.64 1.85 2.42.19.2.19.51 0 .71-.11.1-.24.15-.37.15zm7.17-1.85c-1.19 0-2.24-.3-3.1-.89-1.49-1.01-2.38-2.65-2.38-4.39 0-.28.22-.5.5-.5s.5.22.5.5c0 1.41.72 2.74 1.94 3.56.71.48 1.54.71 2.54.71.24 0 .64-.03 1.04-.1.27-.05.53.13.58.41.05.27-.13.53-.41.58-.57.11-1.07.12-1.21.12z"/>
                  </svg>
                </div>
                <div class="fingerprint-image-container">
                  <canvas id="fingerprintCanvas" width="180" height="210"></canvas>
                </div>
                <p class="capture-text" id="captureText">Ready to Capture</p>
                <p class="capture-subtext" id="captureSubtext">Place your finger firmly on the scanner</p>

                <div class="quality-meter" id="qualityMeter" style="display: none;">
                  <div class="quality-header">
                    <span class="quality-label">Image Quality</span>
                    <span class="quality-value" id="qualityValue">0%</span>
                  </div>
                  <div class="quality-bar">
                    <div class="quality-fill" id="qualityFill" style="width: 0%"></div>
                  </div>
                  <div class="quality-thresholds">
                    <span>Poor</span>
                    <span>Fair</span>
                    <span>Good</span>
                    <span>Excellent</span>
                  </div>
                </div>
              </div>

              <div class="patient-info-panel">
                <div class="form-group">
                  <label class="form-label">Patient ID</label>
                  <input type="text" class="form-input" id="patientId" placeholder="Enter Patient ID">
                </div>

                <div class="form-group">
                  <label class="form-label">Select Finger</label>
                  <div class="finger-selector" id="fingerSelector">
                    <button class="finger-btn" data-finger="0">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>L.Thumb</span>
                    </button>
                    <button class="finger-btn active" data-finger="1">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>L.Index</span>
                    </button>
                    <button class="finger-btn" data-finger="2">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>L.Middle</span>
                    </button>
                    <button class="finger-btn" data-finger="3">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>L.Ring</span>
                    </button>
                    <button class="finger-btn" data-finger="4">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>L.Little</span>
                    </button>
                    <button class="finger-btn" data-finger="5">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>R.Thumb</span>
                    </button>
                    <button class="finger-btn" data-finger="6">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>R.Index</span>
                    </button>
                    <button class="finger-btn" data-finger="7">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>R.Middle</span>
                    </button>
                    <button class="finger-btn" data-finger="8">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>R.Ring</span>
                    </button>
                    <button class="finger-btn" data-finger="9">
                      <div class="finger-icon">ðŸ‘†</div>
                      <span>R.Little</span>
                    </button>
                  </div>
                </div>

                <div class="action-buttons">
                  <button class="btn btn-primary" id="captureBtn" onclick="captureFingerprint()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Capture Fingerprint
                  </button>
                  <div class="btn-row">
                    <button class="btn btn-success" id="enrollBtn" onclick="enrollCurrentCapture()">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                      </svg>
                      Enroll
                    </button>
                    <button class="btn btn-secondary" id="verifyBtn" onclick="verifyCurrentCapture()">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                      </svg>
                      Verify
                    </button>
                  </div>
                </div>

                <div class="results-panel" id="resultsPanel" style="display: none;">
                  <div class="result-item">
                    <span class="result-label">Operation</span>
                    <span class="result-value" id="resultOperation">-</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Status</span>
                    <span class="result-value" id="resultStatus">-</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Match Score</span>
                    <span class="result-value" id="resultScore">-</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Confidence</span>
                    <span class="result-value" id="resultConfidence">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enroll Page -->
      <div class="page-view" id="page-enroll">
        <div class="page-header">
          <h2 class="page-title">Patient Enrollment</h2>
          <p class="page-subtitle">Register new patients with multiple fingerprints for maximum accuracy</p>
        </div>

        <div class="industrial-grade">
          <div class="industrial-grade-icon">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
          </div>
          <div class="industrial-grade-text">
            <h4>Multi-Finger Enrollment for Maximum Security</h4>
            <p>Enroll at least 2 fingers for redundancy | 70% minimum quality required</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">New Patient Enrollment</span>
            <span id="enrollProgress" style="font-size: 0.85rem; color: var(--gray-500);">Step 1 of 3</span>
          </div>
          <div class="card-body">
            <div class="scanner-section">
              <div>
                <div class="form-group">
                  <label class="form-label">Patient ID *</label>
                  <input type="text" class="form-input" id="enrollPatientId" placeholder="Enter unique Patient ID">
                </div>
                <div class="form-group">
                  <label class="form-label">Patient Name</label>
                  <input type="text" class="form-input" id="enrollPatientName" placeholder="Enter patient name">
                </div>
                <div class="form-group">
                  <label class="form-label">Contact Number</label>
                  <input type="text" class="form-input" id="enrollPatientPhone" placeholder="Enter phone number">
                </div>

                <p style="margin: 20px 0 12px; font-weight: 600; color: var(--gray-700);">Select Fingers to Enroll (minimum 2)</p>
                <div class="finger-selector" id="enrollFingerSelector">
                  <button class="finger-btn" data-finger="0" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>L.Thumb</span>
                  </button>
                  <button class="finger-btn selected" data-finger="1" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>L.Index</span>
                  </button>
                  <button class="finger-btn" data-finger="2" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>L.Middle</span>
                  </button>
                  <button class="finger-btn" data-finger="3" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>L.Ring</span>
                  </button>
                  <button class="finger-btn" data-finger="4" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>L.Little</span>
                  </button>
                  <button class="finger-btn" data-finger="5" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>R.Thumb</span>
                  </button>
                  <button class="finger-btn selected" data-finger="6" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>R.Index</span>
                  </button>
                  <button class="finger-btn" data-finger="7" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>R.Middle</span>
                  </button>
                  <button class="finger-btn" data-finger="8" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>R.Ring</span>
                  </button>
                  <button class="finger-btn" data-finger="9" onclick="toggleEnrollFinger(this)">
                    <div class="finger-icon">ðŸ‘†</div>
                    <span>R.Little</span>
                  </button>
                </div>

                <div id="enrolledFingersList" style="margin-top: 16px; padding: 12px; background: var(--gray-50); border-radius: 8px; display: none;">
                  <p style="font-size: 0.8rem; color: var(--gray-600); margin-bottom: 8px;">Enrolled Fingers:</p>
                  <div id="enrolledFingersDisplay" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                </div>

                <div class="action-buttons" style="margin-top: 24px;">
                  <button class="btn btn-primary" id="startEnrollBtn" onclick="startMultiFingerEnrollment()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    Start Multi-Finger Enrollment
                  </button>
                  <button class="btn btn-secondary" id="retryEnrollBtn" onclick="retryCurrentFinger()" style="display: none;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Retry This Finger
                  </button>
                </div>
              </div>

              <div class="fingerprint-capture-area" id="enrollCaptureArea">
                <div class="fingerprint-icon" id="enrollFingerIcon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28z"/>
                  </svg>
                </div>
                <div class="fingerprint-image-container" id="enrollImageContainer" style="display: none;">
                  <canvas id="enrollCanvas" width="180" height="210"></canvas>
                </div>
                <p class="capture-text" id="enrollCaptureText">Ready for Enrollment</p>
                <p class="capture-subtext" id="enrollCaptureSubtext">Select fingers and click Start to begin</p>

                <div class="quality-meter" id="enrollQualityMeter" style="display: none;">
                  <div class="quality-header">
                    <span class="quality-label">Capture Quality</span>
                    <span class="quality-value" id="enrollQualityValue">0%</span>
                  </div>
                  <div class="quality-bar">
                    <div class="quality-fill" id="enrollQualityFill" style="width: 0%"></div>
                  </div>
                  <div class="quality-thresholds">
                    <span>Poor</span>
                    <span>Fair</span>
                    <span>Good</span>
                    <span>Excellent</span>
                  </div>
                </div>

                <div class="accuracy-badge" id="enrollAccuracyBadge" style="display: none;">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  <span id="enrollAccuracyText">Industrial Grade Enrolled</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enrollment Summary Card -->
        <div class="card" id="enrollSummaryCard" style="display: none;">
          <div class="card-header">
            <span class="card-title">Enrollment Summary</span>
          </div>
          <div class="card-body">
            <div class="results-panel" style="display: block;">
              <div class="result-item">
                <span class="result-label">Patient ID</span>
                <span class="result-value" id="summaryPatientId">-</span>
              </div>
              <div class="result-item">
                <span class="result-label">Patient Name</span>
                <span class="result-value" id="summaryPatientName">-</span>
              </div>
              <div class="result-item">
                <span class="result-label">Fingers Enrolled</span>
                <span class="result-value" id="summaryFingersCount">0</span>
              </div>
              <div class="result-item">
                <span class="result-label">Average Quality</span>
                <span class="result-value" id="summaryAvgQuality">-</span>
              </div>
              <div class="result-item">
                <span class="result-label">Status</span>
                <span class="result-value match" id="summaryStatus">Enrollment Complete</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Verify Page -->
      <div class="page-view" id="page-verify">
        <div class="page-header">
          <h2 class="page-title">Patient Verification</h2>
          <p class="page-subtitle">Verify patient identity using fingerprint biometrics</p>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Verify Patient</span>
          </div>
          <div class="card-body">
            <div class="scanner-section">
              <div class="fingerprint-capture-area" id="verifyCaptureArea">
                <div class="fingerprint-icon">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.81 4.47c-.08 0-.16-.02-.23-.06C15.66 3.42 14 3 12.01 3c-1.98 0-3.86.47-5.57 1.41-.24.13-.54.04-.68-.2-.13-.24-.04-.55.2-.68C7.82 2.52 9.86 2 12.01 2c2.13 0 3.99.47 6.03 1.52.25.13.34.43.21.67-.09.18-.26.28-.44.28z"/>
                  </svg>
                </div>
                <p class="capture-text" id="verifyText">Ready to Verify</p>
                <p class="capture-subtext" id="verifySubtext">Place finger on scanner to identify</p>
              </div>

              <div>
                <div class="form-group">
                  <label class="form-label">Verification Mode</label>
                  <select class="form-select" id="verifyMode">
                    <option value="identify">1:N Identification (Find Patient)</option>
                    <option value="verify">1:1 Verification (Confirm Identity)</option>
                  </select>
                </div>

                <div class="form-group" id="verifyPatientIdGroup" style="display: none;">
                  <label class="form-label">Patient ID (for 1:1 verification)</label>
                  <input type="text" class="form-input" id="verifyPatientId" placeholder="Enter Patient ID to verify">
                </div>

                <div class="action-buttons">
                  <button class="btn btn-primary" onclick="startVerification()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    Start Verification
                  </button>
                </div>

                <div class="results-panel" id="verifyResultsPanel" style="display: none;">
                  <div class="result-item">
                    <span class="result-label">Patient ID</span>
                    <span class="result-value" id="verifyResultPatientId">-</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Patient Name</span>
                    <span class="result-value" id="verifyResultName">-</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Match Result</span>
                    <span class="result-value" id="verifyResultMatch">-</span>
                  </div>
                  <div class="result-item">
                    <span class="result-label">Confidence Score</span>
                    <span class="result-value" id="verifyResultScore">-</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page -->
      <div class="page-view" id="page-settings">
        <div class="page-header">
          <h2 class="page-title">Settings</h2>
          <p class="page-subtitle">Configure scanner and server settings</p>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Server Configuration</span>
          </div>
          <div class="card-body">
            <div class="setting-row">
              <div class="setting-info">
                <h4>Backend Server URL</h4>
                <p>URL of your server with SecuGen SDK installed</p>
              </div>
              <div class="setting-control">
                <div style="display: flex; gap: 8px;">
                  <input type="text" class="form-input" id="settingsServerUrl" placeholder="http://localhost:3001">
                  <button class="btn btn-primary" onclick="saveServerUrl()" style="white-space: nowrap;">Save</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Quality Thresholds (Industrial Grade)</span>
          </div>
          <div class="card-body">
            <div class="setting-row">
              <div class="setting-info">
                <h4>Minimum Capture Quality</h4>
                <p>Minimum quality score required for fingerprint capture</p>
              </div>
              <div class="setting-control">
                <select class="form-select" id="minQuality">
                  <option value="60">60% (Industrial Grade - Recommended)</option>
                  <option value="70">70% (High Security)</option>
                  <option value="50">50% (Standard)</option>
                  <option value="40">40% (Basic)</option>
                </select>
              </div>
            </div>
            <div class="setting-row">
              <div class="setting-info">
                <h4>Enrollment Quality</h4>
                <p>Higher quality required for enrollment templates</p>
              </div>
              <div class="setting-control">
                <select class="form-select" id="enrollQuality">
                  <option value="70">70% (Industrial Grade - Recommended)</option>
                  <option value="80">80% (Maximum Security)</option>
                  <option value="60">60% (Standard)</option>
                </select>
              </div>
            </div>
            <div class="setting-row">
              <div class="setting-info">
                <h4>Security Level</h4>
                <p>Matching security level (affects FAR/FRR)</p>
              </div>
              <div class="setting-control">
                <select class="form-select" id="securityLevel">
                  <option value="5">Level 5 - Maximum (FAR: 0.001%)</option>
                  <option value="4" selected>Level 4 - Industrial (FAR: 0.01%)</option>
                  <option value="3">Level 3 - High (FAR: 0.1%)</option>
                  <option value="2">Level 2 - Standard (FAR: 1%)</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Scanner Information</span>
          </div>
          <div class="card-body">
            <div class="setting-row">
              <div class="setting-info">
                <h4>Device</h4>
                <p id="settingsDeviceName">Not connected</p>
              </div>
            </div>
            <div class="setting-row">
              <div class="setting-info">
                <h4>Vendor ID</h4>
                <p id="settingsVendorId">-</p>
              </div>
            </div>
            <div class="setting-row">
              <div class="setting-info">
                <h4>Platform</h4>
                <p id="settingsPlatform">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Configuration
    const API_BASE = 'http://localhost:5050';
    let backendServerUrl = 'http://localhost:3001';
    let isConnected = false;
    let selectedFinger = 1;
    let lastCapture = null;
    let minQuality = 60;
    let enrollQuality = 70;
    let securityLevel = 4;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initFingerSelectors();
      initVerifyMode();
      fetchStatus();
      setInterval(fetchStatus, 3000);
    });

    // Page Navigation
    function showPage(page) {
      document.querySelectorAll('.page-view').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

      document.getElementById(`page-${page}`).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    // Initialize finger selectors
    function initFingerSelectors() {
      document.querySelectorAll('.finger-selector').forEach(selector => {
        selector.querySelectorAll('.finger-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            selector.querySelectorAll('.finger-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedFinger = parseInt(btn.dataset.finger);
          });
        });
      });
    }

    // Initialize verify mode toggle
    function initVerifyMode() {
      document.getElementById('verifyMode').addEventListener('change', (e) => {
        const patientIdGroup = document.getElementById('verifyPatientIdGroup');
        patientIdGroup.style.display = e.target.value === 'verify' ? 'block' : 'none';
      });
    }

    // Toast notification
    function showToast(title, message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = {
        success: '<svg viewBox="0 0 24 24" fill="#10b981"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>',
        error: '<svg viewBox="0 0 24 24" fill="#ef4444"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>',
        warning: '<svg viewBox="0 0 24 24" fill="#f59e0b"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
        info: '<svg viewBox="0 0 24 24" fill="#2563eb"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>'
      };

      toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
      `;

      container.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Update quality display
    function updateQuality(quality) {
      const meter = document.getElementById('qualityMeter');
      const fill = document.getElementById('qualityFill');
      const value = document.getElementById('qualityValue');

      meter.style.display = 'block';
      fill.style.width = `${quality}%`;
      value.textContent = `${quality}%`;

      let level;
      if (quality >= 80) level = 'excellent';
      else if (quality >= 60) level = 'good';
      else if (quality >= 40) level = 'fair';
      else level = 'poor';

      fill.className = `quality-fill ${level}`;
      value.className = `quality-value ${level}`;
    }

    // Fetch scanner status
    async function fetchStatus() {
      try {
        const response = await fetch(`${API_BASE}/scanner/status`);
        const status = await response.json();

        isConnected = status.connected;

        // Update scanner status
        const scannerDot = document.getElementById('scannerDot');
        const scannerStatus = document.getElementById('scannerStatus');
        scannerDot.className = `status-dot ${status.connected ? 'online' : 'offline'}`;
        scannerStatus.textContent = status.connected ? 'Connected' : 'Disconnected';

        // Update connect button
        document.getElementById('connectBtnText').textContent = status.connected ? 'Disconnect' : 'Connect';

        // Update settings page
        if (status.deviceInfo) {
          document.getElementById('settingsDeviceName').textContent = status.deviceInfo.productName || 'SecuGen Scanner';
          document.getElementById('settingsVendorId').textContent = status.deviceInfo.vendorId || '-';
        }
        document.getElementById('settingsPlatform').textContent = status.platform || '-';

        // Update server URL
        if (status.backendServerUrl) {
          backendServerUrl = status.backendServerUrl;
          document.getElementById('settingsServerUrl').value = backendServerUrl;
        }

        // Check backend server
        try {
          const serverCheck = await fetch(`${backendServerUrl}/api/health`, { method: 'GET' });
          document.getElementById('serverDot').className = 'status-dot online';
          document.getElementById('serverStatus').textContent = 'Online';
        } catch (e) {
          document.getElementById('serverDot').className = 'status-dot offline';
          document.getElementById('serverStatus').textContent = 'Offline';
        }

      } catch (err) {
        document.getElementById('scannerDot').className = 'status-dot offline';
        document.getElementById('scannerStatus').textContent = 'Service Error';
      }
    }

    // Toggle connection
    async function toggleConnection() {
      const btn = document.getElementById('connectBtn');
      btn.disabled = true;

      try {
        if (isConnected) {
          await fetch(`${API_BASE}/scanner/disconnect`, { method: 'POST' });
          showToast('Disconnected', 'Scanner disconnected successfully', 'warning');
        } else {
          const response = await fetch(`${API_BASE}/scanner/connect`, { method: 'POST' });
          const result = await response.json();
          if (result.success) {
            showToast('Connected', `Scanner: ${result.deviceInfo?.productName || 'SecuGen'}`, 'success');
          } else {
            throw new Error(result.error);
          }
        }
      } catch (err) {
        showToast('Error', err.message, 'error');
      }

      btn.disabled = false;
      fetchStatus();
    }

    // Capture fingerprint
    async function captureFingerprint() {
      const btn = document.getElementById('captureBtn');
      const area = document.getElementById('captureArea');
      const text = document.getElementById('captureText');
      const subtext = document.getElementById('captureSubtext');

      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Capturing...';
      area.className = 'fingerprint-capture-area active';
      text.textContent = 'Scanning...';
      subtext.textContent = 'Keep your finger steady on the scanner';

      try {
        const response = await fetch(`${API_BASE}/scanner/capture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            timeout: 15000,
            minQuality: minQuality
          })
        });

        const result = await response.json();

        if (result.success) {
          area.className = 'fingerprint-capture-area success';
          text.textContent = 'Capture Successful';
          subtext.textContent = `Quality: ${result.quality}% - Ready for enrollment or verification`;

          updateQuality(result.quality);

          if (result.image) {
            drawFingerprint(result.image, result.width, result.height);
          }

          lastCapture = result;

          if (result.quality >= 80) {
            showToast('Excellent Quality', `Fingerprint captured with ${result.quality}% quality`, 'success');
          } else if (result.quality >= 60) {
            showToast('Good Quality', `Fingerprint captured with ${result.quality}% quality`, 'success');
          } else {
            showToast('Fair Quality', `Consider recapturing for better accuracy (${result.quality}%)`, 'warning');
          }
        } else {
          throw new Error(result.error || 'Capture failed');
        }
      } catch (err) {
        area.className = 'fingerprint-capture-area error';
        text.textContent = 'Capture Failed';
        subtext.textContent = err.message;
        showToast('Capture Failed', err.message, 'error');
      }

      btn.disabled = false;
      btn.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
        Capture Fingerprint
      `;
    }

    // Draw fingerprint
    function drawFingerprint(imageBase64, width, height) {
      const canvas = document.getElementById('fingerprintCanvas');
      const ctx = canvas.getContext('2d');

      try {
        const imageData = atob(imageBase64);
        const imgData = ctx.createImageData(width, height);

        for (let i = 0; i < imageData.length && i < width * height; i++) {
          const pixel = imageData.charCodeAt(i);
          const idx = i * 4;
          imgData.data[idx] = pixel;
          imgData.data[idx + 1] = pixel;
          imgData.data[idx + 2] = pixel;
          imgData.data[idx + 3] = 255;
        }

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = width;
        tempCanvas.height = height;
        tempCanvas.getContext('2d').putImageData(imgData, 0, 0);

        ctx.drawImage(tempCanvas, 0, 0, width, height, 0, 0, canvas.width, canvas.height);
      } catch (e) {
        console.error('Error drawing fingerprint:', e);
      }
    }

    // Enroll current capture
    async function enrollCurrentCapture() {
      const patientId = document.getElementById('patientId').value.trim();
      if (!patientId) {
        showToast('Missing Information', 'Please enter a Patient ID', 'warning');
        return;
      }

      if (!lastCapture) {
        showToast('No Capture', 'Please capture a fingerprint first', 'warning');
        return;
      }

      if (lastCapture.quality < enrollQuality) {
        showToast('Quality Too Low', `Minimum ${enrollQuality}% quality required for enrollment. Current: ${lastCapture.quality}%`, 'error');
        return;
      }

      const btn = document.getElementById('enrollBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div>';

      try {
        const response = await fetch(`${API_BASE}/scanner/enroll`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patientId,
            fingerIndex: selectedFinger,
            timeout: 15000,
            minQuality: enrollQuality,
            securityLevel: securityLevel
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('Enrollment Successful', `Patient ${patientId} enrolled successfully`, 'success');

          // Show results
          const panel = document.getElementById('resultsPanel');
          panel.style.display = 'block';
          document.getElementById('resultOperation').textContent = 'Enrollment';
          document.getElementById('resultStatus').textContent = 'Success';
          document.getElementById('resultStatus').className = 'result-value match';
          document.getElementById('resultScore').textContent = `${result.capture?.quality || '-'}%`;
          document.getElementById('resultConfidence').textContent = 'High (Industrial Grade)';
        } else {
          throw new Error(result.error || 'Enrollment failed');
        }
      } catch (err) {
        showToast('Enrollment Failed', err.message, 'error');
      }

      btn.disabled = false;
      btn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Enroll
      `;
    }

    // Verify current capture
    async function verifyCurrentCapture() {
      const patientId = document.getElementById('patientId').value.trim();
      if (!patientId) {
        showToast('Missing Information', 'Please enter a Patient ID', 'warning');
        return;
      }

      const btn = document.getElementById('verifyBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner spinner-dark"></div>';

      try {
        const response = await fetch(`${API_BASE}/scanner/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patientId,
            fingerIndex: selectedFinger,
            timeout: 15000,
            minQuality: minQuality,
            securityLevel: securityLevel
          })
        });

        const result = await response.json();

        if (result.success) {
          const panel = document.getElementById('resultsPanel');
          panel.style.display = 'block';
          document.getElementById('resultOperation').textContent = 'Verification';

          if (result.verification?.match) {
            document.getElementById('resultStatus').textContent = 'MATCH';
            document.getElementById('resultStatus').className = 'result-value match';
            document.getElementById('resultScore').textContent = `${result.verification.score}%`;
            document.getElementById('resultConfidence').textContent = result.verification.score >= 80 ? 'Very High' : 'High';
            showToast('Verification Successful', `Patient ${patientId} verified with ${result.verification.score}% confidence`, 'success');
          } else {
            document.getElementById('resultStatus').textContent = 'NO MATCH';
            document.getElementById('resultStatus').className = 'result-value no-match';
            document.getElementById('resultScore').textContent = '-';
            document.getElementById('resultConfidence').textContent = '-';
            showToast('Verification Failed', 'Fingerprint does not match', 'warning');
          }
        } else {
          throw new Error(result.error || 'Verification failed');
        }
      } catch (err) {
        showToast('Verification Failed', err.message, 'error');
      }

      btn.disabled = false;
      btn.innerHTML = `
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        Verify
      `;
    }

    // Start verification process
    async function startVerification() {
      const mode = document.getElementById('verifyMode').value;
      const patientId = document.getElementById('verifyPatientId').value.trim();

      if (mode === 'verify' && !patientId) {
        showToast('Missing Information', 'Please enter Patient ID for 1:1 verification', 'warning');
        return;
      }

      showToast('Starting Verification', 'Place your finger on the scanner', 'info');

      const area = document.getElementById('verifyCaptureArea');
      area.className = 'fingerprint-capture-area active';

      try {
        const endpoint = mode === 'identify' ? '/scanner/identify' : '/scanner/verify';
        const response = await fetch(`${API_BASE}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patientId: mode === 'verify' ? patientId : undefined,
            timeout: 15000,
            minQuality: minQuality,
            securityLevel: securityLevel
          })
        });

        const result = await response.json();

        if (result.success) {
          area.className = 'fingerprint-capture-area success';
          document.getElementById('verifyText').textContent = 'Verification Complete';

          const panel = document.getElementById('verifyResultsPanel');
          panel.style.display = 'block';

          if (result.verification?.match || result.identification?.found) {
            const data = result.verification || result.identification;
            document.getElementById('verifyResultPatientId').textContent = data.patientId || patientId;
            document.getElementById('verifyResultName').textContent = data.patientName || '-';
            document.getElementById('verifyResultMatch').textContent = 'VERIFIED';
            document.getElementById('verifyResultMatch').className = 'result-value match';
            document.getElementById('verifyResultScore').textContent = `${data.score || '-'}%`;
            showToast('Identity Verified', `Patient verified successfully`, 'success');
          } else {
            document.getElementById('verifyResultPatientId').textContent = '-';
            document.getElementById('verifyResultName').textContent = '-';
            document.getElementById('verifyResultMatch').textContent = 'NOT FOUND';
            document.getElementById('verifyResultMatch').className = 'result-value no-match';
            document.getElementById('verifyResultScore').textContent = '-';
            showToast('Not Verified', 'No matching patient found', 'warning');
          }
        } else {
          throw new Error(result.error);
        }
      } catch (err) {
        area.className = 'fingerprint-capture-area error';
        showToast('Verification Failed', err.message, 'error');
      }
    }

    // Save server URL
    async function saveServerUrl() {
      const url = document.getElementById('settingsServerUrl').value.trim();
      if (!url) {
        showToast('Invalid URL', 'Please enter a valid server URL', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/config/server`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const result = await response.json();
        if (result.success) {
          backendServerUrl = url;
          showToast('Settings Saved', 'Server URL updated successfully', 'success');
        } else {
          throw new Error(result.error);
        }
      } catch (err) {
        showToast('Error', err.message, 'error');
      }
    }

    // ============================================
    // Multi-Finger Enrollment Functions
    // ============================================

    const fingerNames = ['L.Thumb', 'L.Index', 'L.Middle', 'L.Ring', 'L.Little',
                         'R.Thumb', 'R.Index', 'R.Middle', 'R.Ring', 'R.Little'];
    let selectedEnrollFingers = [1, 6]; // Default: Left Index, Right Index
    let enrolledFingersData = [];
    let currentEnrollIndex = 0;
    let enrollmentInProgress = false;
    let maxRetries = 3;
    let currentRetryCount = 0;

    // Toggle finger selection for enrollment
    function toggleEnrollFinger(btn) {
      if (enrollmentInProgress) return;

      const finger = parseInt(btn.dataset.finger);
      const idx = selectedEnrollFingers.indexOf(finger);

      if (idx > -1) {
        selectedEnrollFingers.splice(idx, 1);
        btn.classList.remove('selected');
      } else {
        selectedEnrollFingers.push(finger);
        btn.classList.add('selected');
      }

      // Update progress display
      updateEnrollProgress();
    }

    function updateEnrollProgress() {
      const total = selectedEnrollFingers.length;
      const enrolled = enrolledFingersData.length;
      document.getElementById('enrollProgress').textContent =
        `${enrolled} of ${total} fingers enrolled`;
    }

    // Start multi-finger enrollment
    async function startMultiFingerEnrollment() {
      const patientId = document.getElementById('enrollPatientId').value.trim();
      const patientName = document.getElementById('enrollPatientName').value.trim();

      if (!patientId) {
        showToast('Missing Information', 'Please enter a Patient ID', 'warning');
        return;
      }

      if (selectedEnrollFingers.length < 2) {
        showToast('Insufficient Fingers', 'Please select at least 2 fingers for enrollment', 'warning');
        return;
      }

      // Reset enrollment state
      enrolledFingersData = [];
      currentEnrollIndex = 0;
      currentRetryCount = 0;
      enrollmentInProgress = true;

      // Update UI
      document.getElementById('startEnrollBtn').disabled = true;
      document.getElementById('startEnrollBtn').innerHTML = '<div class="spinner"></div> Enrolling...';
      document.getElementById('enrollSummaryCard').style.display = 'none';
      document.getElementById('enrolledFingersList').style.display = 'none';

      // Sort fingers for consistent order
      selectedEnrollFingers.sort((a, b) => a - b);

      // Start enrolling first finger
      await enrollNextFinger();
    }

    async function enrollNextFinger() {
      if (currentEnrollIndex >= selectedEnrollFingers.length) {
        // All fingers enrolled - show summary
        completeEnrollment();
        return;
      }

      const fingerIndex = selectedEnrollFingers[currentEnrollIndex];
      const fingerName = fingerNames[fingerIndex];

      // Update UI to show current finger
      updateEnrollProgress();
      document.getElementById('enrollCaptureText').textContent = `Enrolling ${fingerName}`;
      document.getElementById('enrollCaptureSubtext').textContent = 'Place your finger firmly on the scanner';
      document.getElementById('enrollCaptureArea').className = 'fingerprint-capture-area active';
      document.getElementById('enrollFingerIcon').style.display = 'block';
      document.getElementById('enrollImageContainer').style.display = 'none';
      document.getElementById('enrollQualityMeter').style.display = 'none';
      document.getElementById('retryEnrollBtn').style.display = 'none';

      // Highlight current finger in selector
      document.querySelectorAll('#enrollFingerSelector .finger-btn').forEach(btn => {
        btn.classList.remove('capturing');
        if (parseInt(btn.dataset.finger) === fingerIndex) {
          btn.classList.add('capturing');
        }
      });

      showToast('Capture Required', `Place your ${fingerName} on the scanner`, 'info');

      try {
        const patientId = document.getElementById('enrollPatientId').value.trim();

        const response = await fetch(`${API_BASE}/scanner/enroll`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            patientId,
            fingerIndex,
            timeout: 15000,
            minQuality: enrollQuality,
            securityLevel: securityLevel
          })
        });

        const result = await response.json();

        if (result.success && result.capture) {
          const quality = result.capture.quality || 0;

          // Update quality display
          updateEnrollQuality(quality);

          if (quality >= enrollQuality) {
            // Successful enrollment
            enrolledFingersData.push({
              fingerIndex,
              fingerName,
              quality,
              timestamp: Date.now()
            });

            // Mark finger as enrolled in UI
            document.querySelectorAll('#enrollFingerSelector .finger-btn').forEach(btn => {
              if (parseInt(btn.dataset.finger) === fingerIndex) {
                btn.classList.remove('capturing', 'selected');
                btn.classList.add('enrolled');
              }
            });

            // Show success
            document.getElementById('enrollCaptureArea').className = 'fingerprint-capture-area success';
            document.getElementById('enrollCaptureText').textContent = `${fingerName} Enrolled`;
            document.getElementById('enrollCaptureSubtext').textContent = `Quality: ${quality}%`;
            document.getElementById('enrollAccuracyBadge').style.display = 'flex';
            document.getElementById('enrollAccuracyText').textContent = quality >= 80 ? 'Excellent Quality' : 'Good Quality';

            // Draw captured image if available
            if (result.capture.image) {
              drawEnrollFingerprint(result.capture.image, result.capture.width, result.capture.height);
            }

            // Update enrolled fingers display
            updateEnrolledFingersDisplay();

            showToast('Finger Enrolled', `${fingerName} enrolled successfully (${quality}%)`, 'success');

            currentRetryCount = 0;
            currentEnrollIndex++;

            // Wait a moment then continue to next finger
            setTimeout(() => {
              enrollNextFinger();
            }, 1500);

          } else {
            // Quality too low - offer retry
            handleEnrollmentRetry(fingerName, quality, 'Quality too low');
          }

        } else {
          // Capture failed
          handleEnrollmentRetry(fingerName, 0, result.error || 'Capture failed');
        }

      } catch (err) {
        handleEnrollmentRetry(fingerNames[fingerIndex], 0, err.message);
      }
    }

    function handleEnrollmentRetry(fingerName, quality, reason) {
      currentRetryCount++;

      if (currentRetryCount >= maxRetries) {
        // Max retries exceeded - skip this finger
        showToast('Enrollment Failed', `Could not enroll ${fingerName} after ${maxRetries} attempts. Skipping.`, 'error');
        currentRetryCount = 0;
        currentEnrollIndex++;
        setTimeout(() => enrollNextFinger(), 1000);
        return;
      }

      // Offer retry
      document.getElementById('enrollCaptureArea').className = 'fingerprint-capture-area error';
      document.getElementById('enrollCaptureText').textContent = `Retry Required (${currentRetryCount}/${maxRetries})`;
      document.getElementById('enrollCaptureSubtext').textContent = reason;
      document.getElementById('retryEnrollBtn').style.display = 'block';
      document.getElementById('enrollAccuracyBadge').style.display = 'none';

      if (quality > 0) {
        updateEnrollQuality(quality);
      }

      showToast('Retry Needed', `${reason} - Please try again`, 'warning');
    }

    function retryCurrentFinger() {
      document.getElementById('retryEnrollBtn').style.display = 'none';
      enrollNextFinger();
    }

    function updateEnrollQuality(quality) {
      const meter = document.getElementById('enrollQualityMeter');
      const fill = document.getElementById('enrollQualityFill');
      const value = document.getElementById('enrollQualityValue');

      meter.style.display = 'block';
      fill.style.width = `${quality}%`;
      value.textContent = `${quality}%`;

      let level;
      if (quality >= 80) level = 'excellent';
      else if (quality >= 60) level = 'good';
      else if (quality >= 40) level = 'fair';
      else level = 'poor';

      fill.className = `quality-fill ${level}`;
      value.className = `quality-value ${level}`;
    }

    function drawEnrollFingerprint(imageBase64, width, height) {
      const canvas = document.getElementById('enrollCanvas');
      const ctx = canvas.getContext('2d');

      try {
        const imageData = atob(imageBase64);
        const imgData = ctx.createImageData(width, height);

        for (let i = 0; i < imageData.length && i < width * height; i++) {
          const pixel = imageData.charCodeAt(i);
          const idx = i * 4;
          imgData.data[idx] = pixel;
          imgData.data[idx + 1] = pixel;
          imgData.data[idx + 2] = pixel;
          imgData.data[idx + 3] = 255;
        }

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = width;
        tempCanvas.height = height;
        tempCanvas.getContext('2d').putImageData(imgData, 0, 0);

        ctx.drawImage(tempCanvas, 0, 0, width, height, 0, 0, canvas.width, canvas.height);

        document.getElementById('enrollFingerIcon').style.display = 'none';
        document.getElementById('enrollImageContainer').style.display = 'block';
      } catch (e) {
        console.error('Error drawing fingerprint:', e);
      }
    }

    function updateEnrolledFingersDisplay() {
      const container = document.getElementById('enrolledFingersDisplay');
      const list = document.getElementById('enrolledFingersList');

      if (enrolledFingersData.length > 0) {
        list.style.display = 'block';
        container.innerHTML = enrolledFingersData.map(f => `
          <span class="enrolled-finger-badge">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            ${f.fingerName} (${f.quality}%)
          </span>
        `).join('');
      }
    }

    function completeEnrollment() {
      enrollmentInProgress = false;

      // Reset button
      document.getElementById('startEnrollBtn').disabled = false;
      document.getElementById('startEnrollBtn').innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Start Multi-Finger Enrollment
      `;

      // Remove capturing class from all buttons
      document.querySelectorAll('#enrollFingerSelector .finger-btn').forEach(btn => {
        btn.classList.remove('capturing');
      });

      const patientId = document.getElementById('enrollPatientId').value.trim();
      const patientName = document.getElementById('enrollPatientName').value.trim();

      if (enrolledFingersData.length === 0) {
        showToast('Enrollment Failed', 'No fingers were enrolled successfully', 'error');
        document.getElementById('enrollCaptureArea').className = 'fingerprint-capture-area error';
        document.getElementById('enrollCaptureText').textContent = 'Enrollment Failed';
        document.getElementById('enrollCaptureSubtext').textContent = 'No fingers enrolled';
        return;
      }

      // Calculate average quality
      const avgQuality = Math.round(
        enrolledFingersData.reduce((sum, f) => sum + f.quality, 0) / enrolledFingersData.length
      );

      // Show summary
      document.getElementById('enrollSummaryCard').style.display = 'block';
      document.getElementById('summaryPatientId').textContent = patientId;
      document.getElementById('summaryPatientName').textContent = patientName || '-';
      document.getElementById('summaryFingersCount').textContent = `${enrolledFingersData.length} fingers`;
      document.getElementById('summaryAvgQuality').textContent = `${avgQuality}%`;
      document.getElementById('summaryStatus').textContent =
        enrolledFingersData.length >= 2 ? 'Enrollment Complete' : 'Partial Enrollment';
      document.getElementById('summaryStatus').className =
        enrolledFingersData.length >= 2 ? 'result-value match' : 'result-value no-match';

      // Update capture area
      document.getElementById('enrollCaptureArea').className = 'fingerprint-capture-area success';
      document.getElementById('enrollCaptureText').textContent = 'Enrollment Complete';
      document.getElementById('enrollCaptureSubtext').textContent =
        `${enrolledFingersData.length} fingers enrolled with ${avgQuality}% average quality`;
      document.getElementById('enrollAccuracyBadge').style.display = 'flex';
      document.getElementById('enrollAccuracyText').textContent =
        avgQuality >= 80 ? 'Industrial Grade Complete' : 'Enrollment Complete';

      showToast('Enrollment Complete',
        `Successfully enrolled ${enrolledFingersData.length} fingers for ${patientId}`,
        'success');
    }

    // ============================================
    // Capture with Retry Functions
    // ============================================

    let captureRetryCount = 0;
    const maxCaptureRetries = 3;

    async function captureWithRetry(options = {}) {
      captureRetryCount = 0;
      return await attemptCapture(options);
    }

    async function attemptCapture(options) {
      try {
        const response = await fetch(`${API_BASE}/scanner/capture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            timeout: options.timeout || 15000,
            minQuality: options.minQuality || minQuality
          })
        });

        const result = await response.json();

        if (result.success) {
          if (result.quality >= (options.minQuality || minQuality)) {
            return result;
          } else if (captureRetryCount < maxCaptureRetries) {
            captureRetryCount++;
            showToast('Quality Too Low',
              `Quality ${result.quality}% below threshold. Retry ${captureRetryCount}/${maxCaptureRetries}`,
              'warning');
            await new Promise(r => setTimeout(r, 500));
            return await attemptCapture(options);
          } else {
            return {
              success: false,
              error: `Quality too low after ${maxCaptureRetries} attempts. Best: ${result.quality}%`
            };
          }
        } else {
          if (captureRetryCount < maxCaptureRetries) {
            captureRetryCount++;
            showToast('Capture Failed',
              `${result.error || 'Unknown error'}. Retry ${captureRetryCount}/${maxCaptureRetries}`,
              'warning');
            await new Promise(r => setTimeout(r, 1000));
            return await attemptCapture(options);
          }
          return result;
        }
      } catch (err) {
        if (captureRetryCount < maxCaptureRetries) {
          captureRetryCount++;
          showToast('Connection Error',
            `${err.message}. Retry ${captureRetryCount}/${maxCaptureRetries}`,
            'warning');
          await new Promise(r => setTimeout(r, 1000));
          return await attemptCapture(options);
        }
        throw err;
      }
    }
  </script>
</body>
</html>
